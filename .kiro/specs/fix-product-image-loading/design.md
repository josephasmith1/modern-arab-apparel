# Design Document

## Overview

The image loading issues stem from mismatches between the expected image paths generated by the product loader and the actual image files available in the public directory. The system currently uses complex mapping logic to convert product variant names to image file paths, but these mappings are incomplete or incorrect in several cases.

The solution involves creating a comprehensive image audit and mapping system that can:
1. Scan all available images in the public directory
2. Match them to product variants using intelligent pattern matching
3. Update the product data with correct image paths
4. Implement robust fallback mechanisms for missing images
5. Provide validation tools to prevent future issues

## Architecture

### Core Components

#### 1. Image Scanner Service
- **Purpose**: Scan the public/images directory to catalog all available images
- **Location**: `src/lib/image-scanner.ts`
- **Responsibilities**:
  - Recursively scan image directories
  - Parse image filenames to extract product, color, and type information
  - Build a comprehensive mapping of available images
  - Generate metadata about image dimensions and formats

#### 2. Image Matcher Service
- **Purpose**: Match available images to product variants using intelligent algorithms
- **Location**: `src/lib/image-matcher.ts`
- **Responsibilities**:
  - Compare product variant data with available images
  - Use fuzzy matching for color names and product slugs
  - Handle naming inconsistencies (e.g., "olive-green" vs "green")
  - Prioritize matches based on confidence scores
  - Generate suggestions for manual review

#### 3. Product Data Updater
- **Purpose**: Update product data files with correct image paths
- **Location**: `src/lib/product-updater.ts`
- **Responsibilities**:
  - Read existing product data files
  - Apply image path corrections
  - Preserve original data structure and formatting
  - Create backup copies before modifications
  - Validate updated data integrity

#### 4. Image Validation Service
- **Purpose**: Validate that all referenced images exist and are accessible
- **Location**: `src/lib/image-validator.ts`
- **Responsibilities**:
  - Check if image files exist at specified paths
  - Verify image file integrity and format
  - Generate detailed reports of missing or broken images
  - Provide recommendations for fixes

#### 5. Fallback Image Handler
- **Purpose**: Provide graceful fallbacks for missing images
- **Location**: `src/components/SafeImage.tsx` (enhanced)
- **Responsibilities**:
  - Detect failed image loads
  - Display appropriate placeholder images
  - Maintain layout integrity during loading states
  - Log missing images for future fixing

## Components and Interfaces

### Image Metadata Interface
```typescript
interface ImageMetadata {
  path: string;
  filename: string;
  productSlug: string;
  colorSlug: string;
  imageType: 'main' | 'back' | 'lifestyle';
  lifestyleIndex?: number;
  exists: boolean;
  dimensions?: { width: number; height: number };
  fileSize?: number;
}
```

### Image Mapping Interface
```typescript
interface ImageMapping {
  productSlug: string;
  colorName: string;
  expectedPaths: {
    main: string;
    back: string;
    lifestyle: string[];
  };
  actualPaths: {
    main: string | null;
    back: string | null;
    lifestyle: string[];
  };
  confidence: number;
  issues: string[];
}
```

### Validation Report Interface
```typescript
interface ValidationReport {
  totalProducts: number;
  totalVariants: number;
  totalImages: number;
  missingImages: string[];
  brokenReferences: ImageMapping[];
  suggestions: ImageMapping[];
  summary: {
    healthScore: number;
    criticalIssues: number;
    warnings: number;
  };
}
```

## Data Models

### Enhanced Product Color Interface
The existing ProductColor interface will be enhanced to include validation metadata:

```typescript
interface ProductColor {
  name: string;
  swatch: string;
  hex: string;
  images: {
    main: string;
    back: string;
    lifestyle: string[];
  };
  imageValidation?: {
    mainExists: boolean;
    backExists: boolean;
    lifestyleExists: boolean[];
    lastChecked: string;
  };
  variants: ProductVariant[];
}
```

### Image Cache
To improve performance, implement an image cache that stores validation results:

```typescript
interface ImageCache {
  [imagePath: string]: {
    exists: boolean;
    lastChecked: number;
    metadata?: ImageMetadata;
  };
}
```

## Error Handling

### Image Loading Errors
- **404 Errors**: Implement retry logic with exponential backoff
- **Network Errors**: Provide offline-capable fallbacks
- **Malformed Paths**: Sanitize and normalize image paths
- **Permission Errors**: Log and provide alternative images

### Data Validation Errors
- **Invalid JSON**: Provide detailed error messages with line numbers
- **Missing Required Fields**: Use default values where appropriate
- **Type Mismatches**: Implement type coercion with warnings

### File System Errors
- **Missing Directories**: Create directories as needed
- **Permission Issues**: Provide clear error messages and solutions
- **Disk Space**: Monitor and warn about storage limitations

## Testing Strategy

### Unit Tests
- **Image Scanner**: Test directory traversal and filename parsing
- **Image Matcher**: Test fuzzy matching algorithms and confidence scoring
- **Product Updater**: Test data transformation and backup creation
- **Image Validator**: Test existence checks and report generation

### Integration Tests
- **End-to-End Image Loading**: Test complete image loading pipeline
- **Product Data Updates**: Test full product data update workflow
- **Error Recovery**: Test graceful handling of various error conditions

### Performance Tests
- **Large Directory Scanning**: Test with hundreds of images
- **Concurrent Image Validation**: Test parallel validation performance
- **Memory Usage**: Monitor memory consumption during operations

### Visual Regression Tests
- **Image Display**: Ensure images display correctly after updates
- **Fallback Behavior**: Test placeholder image display
- **Layout Integrity**: Verify layouts remain stable during loading

## Implementation Phases

### Phase 1: Audit and Analysis
1. Implement Image Scanner Service
2. Create comprehensive image inventory
3. Generate initial validation report
4. Identify patterns in naming mismatches

### Phase 2: Intelligent Matching
1. Implement Image Matcher Service
2. Create fuzzy matching algorithms
3. Generate mapping suggestions
4. Provide manual review interface

### Phase 3: Data Updates
1. Implement Product Data Updater
2. Apply automatic fixes for high-confidence matches
3. Create backup and rollback mechanisms
4. Update product data files

### Phase 4: Enhanced Error Handling
1. Enhance SafeImage component
2. Implement robust fallback mechanisms
3. Add loading states and error boundaries
4. Improve user experience during image loading

### Phase 5: Validation and Monitoring
1. Implement ongoing validation checks
2. Create monitoring dashboard
3. Set up automated alerts for new issues
4. Provide maintenance tools for administrators